Q.Circuit=function(t,e){this.index=Q.Circuit.index++,Q.isUsefulInteger(t)||(t=3),this.bandwidth=t,Q.isUsefulInteger(e)||(e=5),this.timewidth=e,this.qubits=Array(t).fill(Q.Qubit.HORIZONTAL),this.operations=[],this.needsEvaluation=!0,this.results=[],this.matrix=null,this.history=new Q.History(this)},Object.assign(Q.Circuit,{index:0,help:function(){return Q.help(this)},constants:{},createConstant:Q.createConstant,createConstants:Q.createConstants,fromText:function(t){return void 0===t?new Q.Circuit:(void 0!==t.raw&&(t=""+t.raw),Q.Circuit.fromTableTransposed(t.trim().split(/\r?\n/).filter(function(t){return t.length}).map(function(t,e){return t.trim().split(/[-+\s+=+]/).filter(function(t){return t.length}).map(function(t,e){let i=t.match(/(^\w+)(\.(\w+))*(#(\d+))*/);return{gateSymbol:i[1],operationMomentId:i[3],mappingIndex:+i[5]}})})))},fromText2:function(t){t=`
			H  C  C
			I  C1 C1
			I  X1 S1
			I  X1 S1`;void 0!==t.raw&&(t=""+t.raw),t.trim().split(/\r?\n/).filter(function(t){return t.length}).map(function(t,e){return t.trim().split(/[-+\s+=+]/).filter(function(t){return t.length}).map(function(t,e){t.match(/(^\w+)(\.(\w+))*(#(\d+))*/)})})},fromTableTransposed:function(t){let e=t.length,i=t.reduce(function(t,e){return Math.max(t,e.length)},0),n=new Q.Circuit(e,i);n.bandwidth=e,n.timewidth=i;for(let r=0;r<e;r++){let s=r+1;for(let o=0;o<i;o++){let a=o+1,u=t[r][o],d=!1;for(let l=0;l<r;l++){let c=t[l][o];if(u.gateSymbol===c.gateSymbol&&u.operationMomentId===c.operationMomentId&&Q.isUsefulInteger(u.mappingIndex)&&Q.isUsefulInteger(c.mappingIndex)&&u.mappingIndex!==c.mappingIndex){let h=n.operations.findIndex(function(t){return t.momentIndex===a&&t.registerIndices.includes(l+1)});n.operations[h].registerIndices[u.mappingIndex]=s,n.operations[h].isControlled="*"!=u.gateSymbol,d=!0}}if(!1===d&&"I"!==u.gateSymbol){let f=Q.Gate.findBySymbol(u.gateSymbol),p=[];Q.isUsefulInteger(u.mappingIndex)?p[u.mappingIndex]=s:p[0]=s,n.operations.push({gate:f,momentIndex:a,registerIndices:p,isControlled:!1,operationMomentId:u.operationMomentId})}}}return n.sort$(),n},controlled:function(t){let e=t.getWidth(),i=Q.Matrix.createIdentity(2*e);for(let n=0;n<e;n++)for(let r=0;r<e;r++){let s=t.read(n,r);i.write$(n+e,r+e,s)}return i},expandMatrix:function(t,e,i){let n=[],r=Math.pow(2,t);for(let s=0;s<i.length;s++)i[s]=t-0-i[s];i.reverse();for(let o=0;o<t;o++)-1==i.indexOf(o)&&n.push(o);let a=new Q.Matrix.createZero(r),u=r;for(;u--;){let d=r;for(;d--;){let l=!0,c=n.length;for(;c--;)if((u&1<<n[c])!=(d&1<<n[c])){l=!1;break}if(l){let h=0,f=0,p=i.length;for(;p--;){let g=i[p];h|=(u&1<<g)>>g<<p,f|=(d&1<<g)>>g<<p}a.write$(u,d,e.read(h,f))}}}return a},evaluate:function(t){window.dispatchEvent(new CustomEvent("Q.Circuit.evaluate began",{detail:{circuit:t}})),t.sort$();let e=new Q.Matrix(1,Math.pow(2,t.bandwidth));e.write$(0,0,1);let i=t.operations.length,n=0,r=t.operations.reduce(function(e,r,s){let o;r.registerIndices.length<1/0&&(r.isControlled,o=r.gate.matrix);for(let a=0;a<r.registerIndices.length-1;a++)o=Q.Circuit.controlled(o);let u=r.registerIndices.slice();e=Q.Circuit.expandMatrix(t.bandwidth,o,u).multiply(e),n++;let d=n/i;return window.dispatchEvent(new CustomEvent("Q.Circuit.evaluate progressed",{detail:{circuit:t,progress:d,operationsCompleted:n,operationsTotal:i,momentIndex:r.momentIndex,registerIndices:r.registerIndices,gate:r.gate.name,state:e}})),e},e),s=r.rows.reduce(function(e,i,n){return e.push({state:"|"+parseInt(n,10).toString(2).padStart(t.bandwidth,"0")+"⟩",probability:Math.pow(i[0].absolute(),2)}),e},[]);return t.needsEvaluation=!1,t.matrix=r,t.results=s,window.dispatchEvent(new CustomEvent("Q.Circuit.evaluate completed",{detail:{circuit:t,results:s}})),r}}),Object.assign(Q.Circuit.prototype,{clone:function(){let t=this.copy();return t.qubits=this.qubits.slice(),t.results=this.results.slice(),t.needsEvaluation=this.needsEvaluation,t},evaluate$:function(){return Q.Circuit.evaluate(this),this},report$:function(t){this.needsEvaluation&&this.evaluate$(),Q.isUsefulInteger(t)||(t=20);let e=this,i=this.results.reduce(function(i,n,r){let s=Math.round(n.probability*t),o=t-s;return i+"\n"+(r+1).toString().padStart(Math.ceil(Math.log10(Math.pow(2,e.qubits.length)))," ")+"  "+n.state+"  "+"".padStart(s,"█")+"".padStart(o,"░")+Q.round(Math.round(100*n.probability),8).toString().padStart(4," ")+"% chance"},"")+"\n";return i},try$:function(){this.needsEvaluation&&this.evaluate$();let t=Array(this.results.length);this.results.reduce(function(e,i,n){return e+=i.probability,t[n]=e,e},0);let e=Math.random(),i=t.findIndex(function(t){return e<=t});return i},sort$:function(){return this.operations.sort(function(t,e){return t.momentIndex===e.momentIndex?Math.min(...t.registerIndices)-Math.min(e.registerIndices):t.momentIndex-e.momentIndex}),this},toTable:function(){let t=Array(this.timewidth),e=this;t.timewidth=this.timewidth,t.bandwidth=this.bandwidth,t.fill(0).forEach(function(t,i,n){let r=Array(e.bandwidth);r.fill(0).forEach(function(t,e,i){i[e]={symbol:"I",symbolDisplay:"I",name:"Identity",nameCss:"identity",gateInputIndex:0,bandwidth:0,thisGateAmongMultiQubitGatesIndex:0,aSiblingIsAbove:!1,aSiblingIsBelow:!1}}),n[i]=r});let i=1,n=0,r={};return this.operations.forEach(function(e,s,o){i!==e.momentIndex&&(t[i].gateTypesUsedThisMoment=r,i=e.momentIndex,n=0,r={}),e.registerIndices.length>1&&(t[i-1].multiRegisterOperationIndex=n,n++),void 0===r[e.gate.symbol]?r[e.gate.symbol]=1:r[e.gate.symbol]++;let a=e.gate.name.toLowerCase().replace(/\s+/g,"-");e.registerIndices.forEach(function(i,o){let u=!1;e.registerIndices.length>1&&(u=!0,a=o===e.registerIndices.length-1?"target":"control"),t[e.momentIndex-1][i-1]={symbol:e.gate.symbol,symbolDisplay:e.gate.symbol,name:e.gate.name,nameCss:a,operationIndex:s,momentIndex:e.momentIndex,registerIndex:i,isMultiRegisterOperation:u,multiRegisterOperationIndex:n,gatesOfThisTypeNow:r[e.gate.symbol],indexAmongSiblings:o,siblingExistsAbove:Math.min(...e.registerIndices)<i,siblingExistsBelow:Math.max(...e.registerIndices)>i}}),t[i-1].gateTypesUsedThisMoment=r}),t.forEach(function(t,e){t.forEach(function(e,i){e.isMultiRegisterOperation&&(t.gateTypesUsedThisMoment[e.symbol]>1&&(e.symbolDisplay=e.symbol+"."+(e.gatesOfThisTypeNow-1)),e.symbolDisplay+="#"+e.indexAmongSiblings)})}),t.forEach(function(t){let e=t.reduce(function(t,e){return Math.max(t,e.symbolDisplay.length)},1);t.maximumCharacterWidth=e}),t.maximumCharacterWidth=t.reduce(function(t,e){return Math.max(t,e.maximumCharacterWidth)},1),t},toText:function(t){let e=this.toTable(),i=Array(e.bandwidth).fill("");for(let n=0;n<e.timewidth;n++)for(let r=0;r<e.bandwidth;r++){let s=e[n][r].symbolDisplay.padEnd(e[n].maximumCharacterWidth,"-");t&&n<e.timewidth-1&&(s=e[n][r].symbolDisplay.padEnd(e.maximumCharacterWidth,"-")),n>0&&(s="-"+s),i[r]+=s}return"\n"+i.join("\n")},toDiagram:function(t){let e=this.toTable(),i=Array(3*e.bandwidth+1).fill("");i[0]="        ",this.qubits.forEach(function(t,e){let n=3*e;i[n+1]+="        ",i[n+2]+="r"+(e+1)+"  |"+t.beta.toText().trim()+"⟩─",i[n+3]+="        "});for(let n=0;n<e.timewidth;n++){let r=t?e.maximumCharacterWidth:e[n].maximumCharacterWidth;i[0]+=Q.centerText("m"+(n+1),r+4);for(let s=0;s<e.bandwidth;s++){let o=e[n][s],a="",u="",d="";if("I"===o.symbol)a+="  ",u+="──",d+="  ",a+=" ".padEnd(r),u+=Q.centerText("○",r,"─"),d+=" ".padEnd(r),a+="  ",n<e.timewidth-1?u+="──":u+="  ",d+="  ";else if(o.isMultiRegisterOperation?(a+="╭─",d+="╰─"):(a+="┌─",d+="└─"),u+="┤ ",a+="─".padEnd(r,"─"),u+=Q.centerText(o.symbolDisplay,r),d+="─".padEnd(r,"─"),o.isMultiRegisterOperation?(a+="─╮",d+="─╯"):(a+="─┐",d+="─┘"),u+=n<e.timewidth-1?" ├":" │",o.isMultiRegisterOperation){let l=2*o.multiRegisterOperationIndex%(e[n].maximumCharacterWidth+1)+1;o.siblingExistsAbove&&(a=a.substring(0,l)+"┴"+a.substring(l+1)),o.siblingExistsBelow&&(d=d.substring(0,l)+"┬"+d.substring(l+1))}let c=3*s;i[c+1]+=a,i[c+2]+=u,i[c+3]+=d}}return"\n"+i.join("\n")},toShader:function(){},toGoogleCirq:function(){return headers},toAmazonBraket:function(){let t=`import boto3
from braket.aws import AwsQuantumSimulator, AwsQuantumSimulatorArns
from braket.circuits import Circuit

aws_account_id = boto3.client("sts").get_caller_identity()["Account"]
device = AwsQuantumSimulator(AwsQuantumSimulatorArns.QS1)
s3_folder = (f"braket-output-{aws_account_id}", "folder-name")

`,e=this.operations.reduce(function(t,e){let i=void 0!==e.gate.AmazonBraketName?e.gate.AmazonBraketName:e.gate.symbol.substr(0,1).toLowerCase();return"X"===e.gate.symbol&&e.registerIndices.length>1&&(i="cnot"),"*"===e.gate.symbol&&(i="i"),t+"."+i+"("+e.registerIndices.reduce(function(t,e,i){return t+(i>0?",":"")+(e-1)},"")+")"},"qjs_circuit = Circuit()");0===this.operations.length&&(e+=".i(0)");let i=`

task = device.run(qjs_circuit, s3_folder, shots=100)
print(task.result().measurement_counts)`;return t+e+i},toLatex:function(){return"\\Qcircuit @C=1.0em @R=0.7em {\n"+this.toTable().reduce(function(t,e,i){e.forEach(function(t,e,i){let n="qw";"I"!==t.symbol&&(t.isMultiRegisterOperation?0===t.indexAmongSiblings?n="X"===t.symbol?"targ":t.symbol.toLowerCase():t.indexAmongSiblings>0&&(n="ctrl{?}"):n=t.symbol.toLowerCase()),i[e].latexCommand=n});let n=e.reduce(function(t,e){return Math.max(t,e.latexCommand.length)},0);return e.forEach(function(e,i){t[i]+="& \\"+e.latexCommand.padEnd(n)+"  "}),t},Array(this.bandwidth).fill("\n	")).join("\\\\")+"\n}"},get:function(t,e){return this.operations.find(function(i){return i.momentIndex===t&&i.registerIndices.includes(e)})},clear$:function(t,e){let i=this;if(2!==arguments.length&&Q.warn(`Q.Circuit.clear$ expected 2 arguments but received ${arguments.length}.`),!0!==Q.isUsefulInteger(t))return Q.error(`Q.Circuit attempted to clear an input on Circuit #${i.index} using an invalid moment index:`,t);if(Q.isUsefulInteger(e)&&(e=[e]),e instanceof Array!=!0)return Q.error(`Q.Circuit attempted to clear an input on Circuit #${i.index} using an invalid register indices array:`,e);let n=i.operations.reduce(function(i,n,r){return n.momentIndex===t&&n.registerIndices.some(function(t){return e.includes(t)})&&i.push({index:r,momentIndex:n.momentIndex,registerIndices:n.registerIndices,gate:n.gate}),i},[]);return n.reduce(function(t,e){return i.operations.splice(e.index-t,1),t+1},0),this.sort$(),n.length&&(this.history.record$({redo:{name:"clear$",func:i.clear$,args:Array.from(arguments)},undo:n.reduce(function(t,e){return t.push({name:"set$",func:i.set$,args:[e.gate,e.momentIndex,e.registerIndices]}),t},[])}),n.forEach(function(e){window.dispatchEvent(new CustomEvent("Q.Circuit.clear$",{detail:{circuit:i,momentIndex:t,registerIndices:e.registerIndices}}))})),i},setProperty$:function(t,e){return this[t]=e,this},setName$:function(t){return"function"==typeof t&&(t=t()),this.setProperty$("name",t)},set$:function(t,e,i){let n=this;if("string"==typeof t&&(t=Q.Gate.findBySymbol(t)),t instanceof Q.Gate!=!0)return Q.error(`Q.Circuit attempted to add a gate to circuit #${this.index} at moment #${e} that is not a gate:`,t);if(!0!==Q.isUsefulNumber(e)||!0!==Number.isInteger(e)||e<1||e>this.timewidth)return Q.error(`Q.Circuit attempted to add a gate to circuit #${this.index} at a moment index that is not valid:`,e);if("number"==typeof i&&(i=[i]),i instanceof Array!=!0)return Q.error(`Q.Circuit attempted to add a gate to circuit #${this.index} at moment #${e} with an invalid register indices array:`,i);if(0===i.length)return Q.error(`Q.Circuit attempted to add a gate to circuit #${this.index} at moment #${e} with an empty register indices array:`,i);if(i.reduce(function(t,e){return t&&e>0&&e<=n.bandwidth},!1))return Q.warn(`Q.Circuit attempted to add a gate to circuit #${this.index} at moment #${e} with some out of range qubit indices:`,i);let r=!!n.operations.find(function(n){return e===n.momentIndex&&t===n.gate&&i.length===n.registerIndices.length&&i.every(t=>n.registerIndices.includes(t))});if(!0!==r){this.clear$(e,i);let s=i.length>1&&t!==Q.Gate.SWAP,o={gate:t,momentIndex:e,registerIndices:i,isControlled:s};this.operations.push(o),this.sort$(),this.history.record$({redo:{name:"set$",func:n.set$,args:Array.from(arguments)},undo:[{name:"clear$",func:n.clear$,args:[e,i]}]}),window.dispatchEvent(new CustomEvent("Q.Circuit.set$",{detail:{circuit:n,operation:o}}))}return n},determineRanges:function(t){void 0===t&&(t={});let{qubitFirstIndex:e,qubitRange:i,qubitLastIndex:n,momentFirstIndex:r,momentRange:s,momentLastIndex:o}=t;if("number"!=typeof e&&(e=0),"number"!=typeof n&&"number"!=typeof i&&(n=this.bandwidth),"number"!=typeof n&&"number"==typeof i)n=e+i;else{if("number"!=typeof n||"number"==typeof i)return Q.error("Q.Circuit attempted to copy a circuit but could not understand what qubits to copy.");i=n-e}if("number"!=typeof r&&(r=0),"number"!=typeof o&&"number"!=typeof s&&(o=this.timewidth),"number"!=typeof o&&"number"==typeof s)o=r+s;else{if("number"!=typeof o||"number"==typeof s)return Q.error("Q.Circuit attempted to copy a circuit but could not understand what moments to copy.");s=o-r}return Q.log(.8,"\nQ.Circuit copy operation:","\n\n  qubitFirstIndex",e,"\n  qubitLastIndex ",n,"\n  qubitRange     ",i,"\n\n  momentFirstIndex",r,"\n  momentLastIndex ",o,"\n  momentRange     ",s,"\n\n"),{qubitFirstIndex:e,qubitRange:i,qubitLastIndex:n,momentFirstIndex:r,momentRange:s,momentLastIndex:o}},copy:function(t,e){let{registerFirstIndex:i,registerRange:n,registerLastIndex:r,momentFirstIndex:s,momentRange:o,momentLastIndex:a}=this.determineRanges(t),u=new Q.Circuit(n,o);return this.operations.filter(function(t){return t.registerIndices.every(function(e){return t.momentIndex>=s&&t.momentIndex<a&&t.registerIndex>=i&&t.registerIndex<r})}).forEach(function(t){let e=t.registerIndices.map(function(t){return t-i});u.set$(t.gate,1+m-s,e)}),u},cut$:function(t){return this.copy(t,!0)},spliceCut$:function(t){let{qubitFirstIndex:e,qubitRange:i,qubitLastIndex:n,momentFirstIndex:r,momentRange:s,momentLastIndex:o}=this.determineRanges(t);return i!==this.bandwidth&&s!==this.timewidth?Q.error(`Q.Circuit attempted to splice circuit #${this.index} by an area that did not include all qubits _or_ all moments.`):(i===this.bandwidth&&(this.moments=this.moments.reduce(function(t,e,i){return(i<r-1||i>=o-1)&&t.push(e),t},[]),this.timewidth-=s),s===this.timewidth&&(this.inputs.splice(e,i),this.moments=this.moments.map(function(t){return t.reduce(function(t,i){return i.qubitIndices.every(function(t){return t<e||t>=n})&&t.push(i),t},[]).map(function(t){return t.qubitIndices=t.qubitIndices.map(function(t){return t>=n?t-i:t}),t})}),this.bandwidth-=i),this.removeHangingOperations$(),this.fillEmptyOperations$(),this)},splicePaste$:function(){},paste$:function(t,e=0,i=0,n=!0){let r=this;return this.timewidth=Math.max(this.timewidth,e+t.timewidth),this.bandwidth=Math.max(this.bandwidth,i+t.bandwidth),this.ensureMomentsAreReady$(),this.fillEmptyOperations$(),t.moments.forEach(function(t,n){t.forEach(function(t){r.set$(t.gate,n+e+1,t.qubitIndices.map(function(t){return t+i}))})}),n&&this.removeHangingOperations$(),this.fillEmptyOperations$(),this},pasteInsert$:function(t,e,i){return shouldClean&&this.removeHangingOperations$(),this.fillEmptyOperations$(),this},expand$:function(){return this.fillEmptyOperations$(),thiis},trim$:function(t){let{qubitFirstIndex:e,qubitRange:i,qubitLastIndex:n,momentFirstIndex:r,momentRange:s,momentLastIndex:o}=this.determineRanges(t);return this.moments=this.moments.slice(r,o),this.timewidth=s,this.inputs=this.inputs.slice(e,n),this.bandwidth=i,this.removeHangingOperations$(),this.fillEmptyOperations$(),this}}),Object.entries(Q.Gate.constants).forEach(function(t){let e=t[0],i=t[1],n=function(t,e){return this.set$(i,t,e),this};Q.Circuit.prototype[e]=n,Q.Circuit.prototype[i.symbol]=n,Q.Circuit.prototype[i.symbol.toLowerCase()]=n}),Q.Circuit.createConstants("BELL",Q`

		H  X#0
		I  X#1
	`);